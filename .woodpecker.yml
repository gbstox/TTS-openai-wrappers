# Woodpecker CI Pipeline for TTS OpenAI Wrappers
#
# Builds, pushes, and deploys Docker images for each TTS engine.
# Images are pushed to GitHub Container Registry (ghcr.io).
# After push, Runpod endpoints are updated to trigger rolling releases.
#
# Required Secrets:
#   - GITHUB_TOKEN: GitHub token with packages:write scope
#   - GITHUB_USERNAME: GitHub username for GHCR login
#   - RUNPOD_API_KEY: Runpod API key for deployment
#   - RUNPOD_TEMPLATE_<ENGINE>: Template ID for each engine (e.g., RUNPOD_TEMPLATE_QWEN3TTS)

variables:
  - &registry "ghcr.io"
  - &owner "gbstox"

# Only build on pushes to main or manual triggers
when:
  - event: push
    branch: main
  - event: manual

matrix:
  ENGINE:
    - kokoro
    - cosyvoice
    - fishspeech
    - qwen3tts

steps:
  # Build and push Docker image
  build-and-push:
    image: docker:24-dind
    privileged: true
    environment:
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client
    commands:
      - echo "Building ${ENGINE} engine..."
      
      # Wait for Docker daemon
      - sleep 5
      
      # Login to GHCR
      - echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
      
      # Build the image
      - docker build 
          -t ghcr.io/${OWNER}/tts-${ENGINE}:latest 
          -t ghcr.io/${OWNER}/tts-${ENGINE}:${CI_COMMIT_SHA:0:7}
          -f engines/${ENGINE}/Dockerfile 
          .
      
      # Push the image
      - docker push ghcr.io/${OWNER}/tts-${ENGINE}:latest
      - docker push ghcr.io/${OWNER}/tts-${ENGINE}:${CI_COMMIT_SHA:0:7}
      
      - echo "Pushed ghcr.io/${OWNER}/tts-${ENGINE}:latest"
    secrets:
      - GITHUB_TOKEN
      - GITHUB_USERNAME
    when:
      - event: push
        branch: main

  # Deploy to Runpod - update template to trigger rolling release
  deploy-runpod:
    image: alpine:latest
    commands:
      - apk add --no-cache curl jq
      
      # Get the template ID for this engine from environment
      # Secret names like RUNPOD_TEMPLATE_QWEN3TTS are converted to uppercase
      - ENGINE_UPPER=$(echo "${ENGINE}" | tr '[:lower:]' '[:upper:]')
      - TEMPLATE_VAR="RUNPOD_TEMPLATE_${ENGINE_UPPER}"
      - TEMPLATE_ID=$(printenv "$TEMPLATE_VAR" || echo "")
      
      - |
        if [ -z "$TEMPLATE_ID" ]; then
          echo "No template ID configured for ${ENGINE} (expected \$${TEMPLATE_VAR})"
          echo "Skipping Runpod deployment for ${ENGINE}"
          exit 0
        fi
      
      - echo "Deploying ${ENGINE} to Runpod template ${TEMPLATE_ID}..."
      
      # Update the template with the new image
      - |
        RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
          "https://rest.runpod.io/v1/templates/${TEMPLATE_ID}" \
          -H "Authorization: Bearer ${RUNPOD_API_KEY}" \
          -H "Content-Type: application/json" \
          -d "{\"imageName\": \"ghcr.io/${OWNER}/tts-${ENGINE}:${CI_COMMIT_SHA:0:7}\"}")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "Successfully updated Runpod template for ${ENGINE}"
          echo "Response: $BODY" | jq .
        else
          echo "Failed to update Runpod template. HTTP $HTTP_CODE"
          echo "Response: $BODY"
          exit 1
        fi
    secrets:
      - RUNPOD_API_KEY
      - RUNPOD_TEMPLATE_KOKORO
      - RUNPOD_TEMPLATE_COSYVOICE
      - RUNPOD_TEMPLATE_FISHSPEECH
      - RUNPOD_TEMPLATE_QWEN3TTS
    when:
      - event: push
        branch: main

  # Build only (no push) for PRs and testing
  build-test:
    image: docker:24-dind
    privileged: true
    environment:
      - DOCKER_HOST=tcp://docker:2376
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs/client
    commands:
      - echo "Building ${ENGINE} engine (test only)..."
      - sleep 5
      - docker build 
          -t tts-${ENGINE}:test 
          -f engines/${ENGINE}/Dockerfile 
          .
      - echo "Build successful for ${ENGINE}"
    when:
      - event: pull_request

services:
  docker:
    image: docker:24-dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs
    volumes:
      - /certs/client
# Trigger build 20260125-191518
