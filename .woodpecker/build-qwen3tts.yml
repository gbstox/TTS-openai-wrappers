# Woodpecker CI - Build Qwen3-TTS Only
#
# Standalone build for Qwen3-TTS with explicit timeout.
# This pipeline can be manually triggered independently.

labels:
  platform: linux/amd64

when:
  - event: manual

steps:
  # Initial cleanup
  cleanup:
    image: docker:latest
    commands:
      - echo "=== Initial Cleanup ==="
      - docker system prune -af || true
      - docker builder prune -af || true
      - df -h / || true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # Build Qwen3-TTS with extended timeout
  build-qwen3tts:
    image: docker:latest
    commands:
      - echo "=== Building Qwen3-TTS ==="
      - df -h / || true
      - echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
      - |
        echo "Starting docker build..."
        docker build \
          -t ghcr.io/gbstox/tts-qwen3tts:latest \
          -t ghcr.io/gbstox/tts-qwen3tts:${CI_COMMIT_SHA:0:7} \
          -f engines/qwen3tts/Dockerfile .
      - echo "=== Build complete ==="
      - df -h / || true
      - |
        echo "Starting push of :latest..."
        docker push ghcr.io/gbstox/tts-qwen3tts:latest
        echo "=== Pushed :latest ==="
      - |
        echo "Starting push of commit tag..."
        docker push ghcr.io/gbstox/tts-qwen3tts:${CI_COMMIT_SHA:0:7}
        echo "=== Pushed commit tag ==="
      - echo "=== Successfully pushed tts-qwen3tts ==="
      - docker rmi ghcr.io/gbstox/tts-qwen3tts:latest ghcr.io/gbstox/tts-qwen3tts:${CI_COMMIT_SHA:0:7} || true
      - docker builder prune -af || true
    secrets:
      - github_token
      - github_username
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - cleanup
